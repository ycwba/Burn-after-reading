<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜…åå³ç„š - å®‰å…¨åˆ†äº«ä½ çš„ç§˜å¯†</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ”</text></svg>">
</head>
<body>
    <div class="container">
        <!-- åˆ›å»ºæ¶ˆæ¯éƒ¨åˆ† -->
        <div id="create-section">
            <h1>é˜…åå³ç„š</h1>
            <textarea id="secret-message" placeholder="åœ¨æ­¤è¾“å…¥ä½ çš„ç§˜å¯†æ¶ˆæ¯..." required></textarea>
            <input type="password" id="encryption-key" placeholder="è®¾ç½®è®¿é—®å¯†ç ï¼ˆå¯é€‰ï¼‰">
            <button onclick="createMessage()">åˆ›å»ºåŠ å¯†æ¶ˆæ¯</button>
            <div id="generated-link-container" style="display: none;">
                <p>åˆ†äº«ä»¥ä¸‹é“¾æ¥ï¼š</p>
                <a id="generated-link" href="#" target="_blank"></a>
                <p class="warning">æ³¨æ„ï¼šæ­¤æ¶ˆæ¯åœ¨è¢«æŸ¥çœ‹åå°†ç«‹å³é”€æ¯</p>
            </div>
        </div>

        <!-- æŸ¥çœ‹æ¶ˆæ¯éƒ¨åˆ† -->
        <div id="view-section" style="display: none;">
            <h2>æŸ¥çœ‹åŠ å¯†æ¶ˆæ¯</h2>
            <div id="password-section" style="display: none;">
                <input type="password" id="decryption-key" placeholder="è¯·è¾“å…¥è®¿é—®å¯†ç ">
                <button onclick="decryptMessage()">è§£å¯†æ¶ˆæ¯</button>
            </div>div>
            <div id="message-display"></div>
            <div id="message-status"></div>
        </div>
    </div>

    <script>
        // è·å–URLå‚æ•°çš„å‡½æ•°
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // ç”ŸæˆéšæœºID
        function generateId(length = 10) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // åŠ å¯†æ¶ˆæ¯
        async function encryptMessage(message, key) {
            const encoder = new TextEncoder();
            const data = encoder.encode(message);
            
            let cryptoKey;
            if (key) {
                const keyData = encoder.encode(key);
                const hashBuffer = await crypto.subtle.digest('SHA-256', keyData);
                cryptoKey = await crypto.subtle.importKey(
                    'raw',
                    hashBuffer,
                    { name: 'AES-GCM' },
                    false,
                    ['encrypt']
                );
            }

            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encryptedData = key
                ? await crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv: iv },
                    cryptoKey,
                    data
                )
                : data;

            return {
                iv: Array.from(iv),
                data: Array.from(new Uint8Array(encryptedData))
            };
        }

        // è§£å¯†æ¶ˆæ¯
        async function decryptMessage() {
            const messageId = getQueryParam('id');
            const key = document.getElementById('decryption-key').value;

            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${messageId}/latest`, {
                    headers: {
                        'X-Master-Key': '$2b$10$xxxxxyyyyyzzzz.aaaaaaaaaa'
                    }
                });

                if (!response.ok) {
                    throw new Error('æ¶ˆæ¯ä¸å­˜åœ¨æˆ–å·²è¢«é”€æ¯');
                }

                const { record: { encrypted, iv } } = await response.json();

                const decoder = new TextEncoder();
                const keyData = decoder.encode(key);
                const hashBuffer = await crypto.subtle.digest('SHA-256', keyData);
                const cryptoKey = await crypto.subtle.importKey(
                    'raw',
                    hashBuffer,
                    { name: 'AES-GCM' },
                    false,
                    ['decrypt']
                );

                const decryptedData = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: new Uint8Array(iv) },
                    cryptoKey,
                    new Uint8Array(encrypted)
                );

                const decryptedMessage = new TextDecoder().decode(decryptedData);
                displayMessage(decryptedMessage);

                // åˆ é™¤æ¶ˆæ¯
                await fetch(`https://api.jsonbin.io/v3/b/${messageId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-Master-Key': '$2b$10$xxxxxyyyyyzzzz.aaaaaaaaaa'
                    }
                });

            } catch (error) {
                document.getElementById('message-status').textContent = 'æ— æ³•è§£å¯†æ¶ˆæ¯ï¼š' + error.message;
            }
        }

        // åˆ›å»ºæ¶ˆæ¯
        async function createMessage() {
            const message = document.getElementById('secret-message').value;
            const key = document.getElementById('encryption-key').value;

            if (!message) {
                alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
                return;
            }

            try {
                const encrypted = await encryptMessage(message, key);
                const messageId = generateId();

                const response = await fetch('https://api.jsonbin.io/v3/b', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': '$2b$10$xxxxxyyyyyzzzz.aaaaaaaaaa'
                    },
                    body: JSON.stringify({
                        encrypted: encrypted.data,
                        iv: encrypted.iv
                    })
                });

                if (!response.ok) {
                    throw new Error('æ— æ³•ä¿å­˜æ¶ˆæ¯');
                }

                const { id } = await response.json();
                const link = `${window.location.origin}${window.location.pathname}?id=${id}`;
                
                document.getElementById('generated-link').href = link;
                document.getElementById('generated-link').textContent = link;
                document.getElementById('generated-link-container').style.display = 'block';

            } catch (error) {
                alert('åˆ›å»ºæ¶ˆæ¯å¤±è´¥ï¼š' + error.message);
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function displayMessage(message) {
            const messageDisplay = document.getElementById('message-display');
            messageDisplay.innerHTML = `
                <p>è§£å¯†çš„æ¶ˆæ¯ï¼š</p>
                <pre>${message}</pre>
                <p class="warning">æ­¤æ¶ˆæ¯å·²è¢«é”€æ¯ï¼Œæ— æ³•å†æ¬¡æŸ¥çœ‹</p>
            `;
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰æ¶ˆæ¯ID
        window.onload = function() {
            const messageId = getQueryParam('id');
            if (messageId) {
                document.getElementById('create-section').style.display = 'none';
                document.getElementById('view-section').style.display = 'block';
                document.getElementById('password-section').style.display = 'block';
            }
        };
    </script>
</body>
</html>
