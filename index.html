<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>阅后即焚 - 安全分享你的秘密</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🔐</text></svg>">
</head>
<body>
    <div class="container">
        <!-- 创建消息部分 -->
        <div id="create-section">
            <h1>阅后即焚</h1>
            <textarea id="secret-message" placeholder="在此输入你的秘密消息..." required></textarea>
            <input type="password" id="encryption-key" placeholder="设置访问密码（可选）">
            <button onclick="createMessage()">创建加密消息</button>
            <div id="generated-link-container" style="display: none;">
                <p>分享以下链接：</p>
                <a id="generated-link" href="#" target="_blank"></a>
                <p class="warning">注意：此消息在被查看后将立即销毁</p>
            </div>
        </div>

        <!-- 查看消息部分 -->
        <div id="view-section" style="display: none;">
            <h2>查看加密消息</h2>
            <div id="password-section" style="display: none;">
                <input type="password" id="decryption-key" placeholder="请输入访问密码">
                <button onclick="decryptMessage()">解密消息</button>
            </div>div>
            <div id="message-display"></div>
            <div id="message-status"></div>
        </div>
    </div>

    <script>
        // 获取URL参数的函数
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // 生成随机ID
        function generateId(length = 10) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // 加密消息
        async function encryptMessage(message, key) {
            const encoder = new TextEncoder();
            const data = encoder.encode(message);
            
            let cryptoKey;
            if (key) {
                const keyData = encoder.encode(key);
                const hashBuffer = await crypto.subtle.digest('SHA-256', keyData);
                cryptoKey = await crypto.subtle.importKey(
                    'raw',
                    hashBuffer,
                    { name: 'AES-GCM' },
                    false,
                    ['encrypt']
                );
            }

            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encryptedData = key
                ? await crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv: iv },
                    cryptoKey,
                    data
                )
                : data;

            return {
                iv: Array.from(iv),
                data: Array.from(new Uint8Array(encryptedData))
            };
        }

        // 解密消息
        async function decryptMessage() {
            const messageId = getQueryParam('id');
            const key = document.getElementById('decryption-key').value;

            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${messageId}/latest`, {
                    headers: {
                        'X-Master-Key': '$2b$10$xxxxxyyyyyzzzz.aaaaaaaaaa'
                    }
                });

                if (!response.ok) {
                    throw new Error('消息不存在或已被销毁');
                }

                const { record: { encrypted, iv } } = await response.json();

                const decoder = new TextEncoder();
                const keyData = decoder.encode(key);
                const hashBuffer = await crypto.subtle.digest('SHA-256', keyData);
                const cryptoKey = await crypto.subtle.importKey(
                    'raw',
                    hashBuffer,
                    { name: 'AES-GCM' },
                    false,
                    ['decrypt']
                );

                const decryptedData = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: new Uint8Array(iv) },
                    cryptoKey,
                    new Uint8Array(encrypted)
                );

                const decryptedMessage = new TextDecoder().decode(decryptedData);
                displayMessage(decryptedMessage);

                // 删除消息
                await fetch(`https://api.jsonbin.io/v3/b/${messageId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-Master-Key': '$2b$10$xxxxxyyyyyzzzz.aaaaaaaaaa'
                    }
                });

            } catch (error) {
                document.getElementById('message-status').textContent = '无法解密消息：' + error.message;
            }
        }

        // 创建消息
        async function createMessage() {
            const message = document.getElementById('secret-message').value;
            const key = document.getElementById('encryption-key').value;

            if (!message) {
                alert('请输入消息内容');
                return;
            }

            try {
                const encrypted = await encryptMessage(message, key);
                const messageId = generateId();

                const response = await fetch('https://api.jsonbin.io/v3/b', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': '$2b$10$xxxxxyyyyyzzzz.aaaaaaaaaa'
                    },
                    body: JSON.stringify({
                        encrypted: encrypted.data,
                        iv: encrypted.iv
                    })
                });

                if (!response.ok) {
                    throw new Error('无法保存消息');
                }

                const { id } = await response.json();
                const link = `${window.location.origin}${window.location.pathname}?id=${id}`;
                
                document.getElementById('generated-link').href = link;
                document.getElementById('generated-link').textContent = link;
                document.getElementById('generated-link-container').style.display = 'block';

            } catch (error) {
                alert('创建消息失败：' + error.message);
            }
        }

        // 显示消息
        function displayMessage(message) {
            const messageDisplay = document.getElementById('message-display');
            messageDisplay.innerHTML = `
                <p>解密的消息：</p>
                <pre>${message}</pre>
                <p class="warning">此消息已被销毁，无法再次查看</p>
            `;
        }

        // 页面加载时检查是否有消息ID
        window.onload = function() {
            const messageId = getQueryParam('id');
            if (messageId) {
                document.getElementById('create-section').style.display = 'none';
                document.getElementById('view-section').style.display = 'block';
                document.getElementById('password-section').style.display = 'block';
            }
        };
    </script>
</body>
</html>
